rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role from Firestore user document
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.role : null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Helper function to check if user is range admin
    function isRangeAdmin() {
      return isAuthenticated() && getUserRole() == 'range_admin';
    }
    
    // Helper function to get user's range info
    function getUserRange() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data : null;
    }
    
    // Helper function to check if competition belongs to range admin's range
    function isMyRangeCompetition() {
      return isRangeAdmin() && 
             getUserRange() != null && 
             ((resource.data.range != null && resource.data.range.id == getUserRange().rangeId) ||
              (resource.data.range != null && resource.data.range.name == getUserRange().rangeName) ||
              resource.data.rangeId == getUserRange().rangeId);
    }
    
    // Allow read access to published competitions (public for published, authenticated for others)
    match /competitions/{competitionId} {
      allow read: if resource.data.status == 'published' || isAdmin() || isRangeAdmin() || 
                     (isAuthenticated() && resource.data.status != null);
      allow create: if isAdmin() || isRangeAdmin();
      allow update: if isAdmin() || (isRangeAdmin() && isMyRangeCompetition());
      allow delete: if isAdmin() || (isRangeAdmin() && isMyRangeCompetition());
    }
    
    // Allow users to read their own data and update their profile
    // Also allow limited public read for leaderboard display (basic profile info only)
    match /users/{userId} {
      // Allow public read for non-admin users (for leaderboards)
      // Allow authenticated users to read their own profile or admins to read any profile
      allow read: if (resource.data.role != 'admin' && resource.data.role != 'range_admin') ||
                     (isAuthenticated() && (request.auth.uid == userId || isAdmin()));
      // Write access
      allow write: if isAuthenticated() && 
                      (request.auth.uid == userId || isAdmin());
    }
    
    // Helper function to check if score belongs to range admin's competitions
    function isMyRangeScore() {
      let userData = getUserRange();
      let compId = resource.data.competitionId;
      let compExists = compId != null && exists(/databases/$(database)/documents/competitions/$(compId));
      let compData = compExists ? get(/databases/$(database)/documents/competitions/$(compId)).data : null;
      return isRangeAdmin() && 
             userData != null &&
             compExists &&
             compData != null &&
             ((compData.range != null && compData.range.id == userData.rangeId) ||
              (compData.range != null && compData.range.name == userData.rangeName) ||
              compData.rangeId == userData.rangeId);
    }
    
    // Allow authenticated users to create scores
    // Allow public read of approved scores for leaderboards
    match /scores/{scoreId} {
      allow read: if resource.data.verificationStatus == 'approved' || 
                     !resource.data.verificationStatus ||
                     isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAdmin() || (isRangeAdmin() && isMyRangeScore());
      allow delete: if isAdmin() || (isRangeAdmin() && isMyRangeScore());
    }
    
    // Ranges collection - allow admins to manage, public read
    match /ranges/{rangeId} {
      allow read: if true; // Public read access
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Registrations collection
    match /registrations/{registrationId} {
      // Allow public read of registrations (for participant lists on competition pages)
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || isAdmin());
      allow delete: if isAdmin() || 
                      (isAuthenticated() && request.auth.uid == resource.data.userId);
    }
  }
}

