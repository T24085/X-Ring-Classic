rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role from Firestore user document
    function getUserRole() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role : null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Helper function to check if user is range admin
    function isRangeAdmin() {
      return isAuthenticated() && getUserRole() == 'range_admin';
    }
    
    // Helper function to get user's range info
    function getUserRange() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data : null;
    }
    
    // Helper function to check if competition belongs to range admin's range
    function isMyRangeCompetition() {
      return isRangeAdmin() && 
             getUserRange() != null && 
             ((resource.data.range != null && resource.data.range.id == getUserRange().rangeId) ||
              (resource.data.range != null && resource.data.range.name == getUserRange().rangeName) ||
              resource.data.rangeId == getUserRange().rangeId);
    }
    
    // Competitions - Public can read published, authenticated can read all
    match /competitions/{competitionId} {
      allow read: if resource.data.status == 'published' || isAuthenticated();
      allow create: if isAuthenticated() && (getUserRole() == 'admin' || getUserRole() == 'range_admin');
      allow update: if isAuthenticated() && (getUserRole() == 'admin' || (getUserRole() == 'range_admin' && isMyRangeCompetition()));
      allow delete: if isAuthenticated() && (getUserRole() == 'admin' || (getUserRole() == 'range_admin' && isMyRangeCompetition()));
    }
    
    // Users - Public can read non-admin users, authenticated users can read all profiles (for leaderboards)
    match /users/{userId} {
      allow read: if 
        // Public can read non-admin/range_admin users
        (resource.data.role == null || (resource.data.role != 'admin' && resource.data.role != 'range_admin')) ||
        // Authenticated users can read any profile (for leaderboards - everyone should see names)
        isAuthenticated();
      allow write: if isAuthenticated() && (request.auth.uid == userId || getUserRole() == 'admin');
    }
    
    // Helper function to check if score belongs to range admin's competitions
    function isMyRangeScore() {
      let userData = getUserRange();
      let compId = resource.data.competitionId;
      let compExists = compId != null && exists(/databases/$(database)/documents/competitions/$(compId));
      let compData = compExists ? get(/databases/$(database)/documents/competitions/$(compId)).data : null;
      return isRangeAdmin() && 
             userData != null &&
             compExists &&
             compData != null &&
             ((compData.range != null && compData.range.id == userData.rangeId) ||
              (compData.range != null && compData.range.name == userData.rangeName) ||
              compData.rangeId == userData.rangeId);
    }
    
    // Scores - Public can read approved/null, authenticated can read all
    match /scores/{scoreId} {
      allow read: if resource.data.verificationStatus == 'approved' || 
                     resource.data.verificationStatus == null ||
                     isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (getUserRole() == 'admin' || (getUserRole() == 'range_admin' && isMyRangeScore()));
      allow delete: if isAuthenticated() && (getUserRole() == 'admin' || (getUserRole() == 'range_admin' && isMyRangeScore()));
    }
    
    // Ranges - Public read, admin write
    match /ranges/{rangeId} {
      allow read: if true;
      allow create: if isAuthenticated() && getUserRole() == 'admin';
      allow update: if isAuthenticated() && getUserRole() == 'admin';
      allow delete: if isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Registrations - Public read, authenticated create/update own
    match /registrations/{registrationId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == resource.data.userId || getUserRole() == 'admin');
      allow delete: if isAuthenticated() && (getUserRole() == 'admin' || request.auth.uid == resource.data.userId);
    }
  }
}

